<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>EVEREST Eswatini Marketplace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }
        
        body {
            background: #0a192f;
            color: white;
            min-height: 100vh;
        }
        
        /* CUSTOM ALERT STYLES */
        #customAlert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            display: none;
            max-width: 350px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-content {
            background: #172a45;
            border-left: 5px solid;
            border-radius: 12px;
            padding: 1.2rem 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
        }
        
        .alert-success {
            border-left-color: #10b981;
        }
        
        .alert-success .alert-icon {
            background: #10b981;
        }
        
        .alert-error {
            border-left-color: #ef4444;
        }
        
        .alert-error .alert-icon {
            background: #ef4444;
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .alert-message {
            flex: 1;
            color: #e6f1ff;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .alert-close {
            background: none;
            border: none;
            color: #8892b0;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .alert-close:hover {
            color: #ef4444;
        }
        
        /* SIGN UP PAGE */
        #signupPage {
            width: 100%;
            min-height: 100vh;
            background: #0a192f;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        .signup-container {
            width: 100%;
            max-width: 400px;
            background: #172a45;
            padding: 2rem 1.5rem;
            border-radius: 20px;
            border: 2px solid #64ffda;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .signup-container h1 {
            color: #64ffda;
            font-size: 2.8rem;
            text-align: center;
            margin-bottom: 0.3rem;
            font-family: Georgia, serif;
        }
        
        .signup-container .subtitle {
            text-align: center;
            color: #8892b0;
            margin-bottom: 1.8rem;
            font-size: 0.9rem;
        }
        
        .signup-container input {
            width: 100%;
            padding: 0.9rem 1rem;
            margin: 0.5rem 0;
            background: #0a192f;
            border: 2px solid #64ffda;
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .signup-container input:focus {
            outline: none;
            border-color: #00b4d8;
            box-shadow: 0 0 0 3px rgba(100,255,218,0.2);
        }
        
        .signup-container input.invalid {
            border-color: #ef4444;
        }
        
        .signup-container input.valid {
            border-color: #10b981;
        }
        
        .signup-container button {
            width: 100%;
            padding: 1rem;
            margin: 1.5rem 0 1rem;
            background: linear-gradient(135deg, #64ffda, #00b4d8);
            color: #0a192f;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .signup-container button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px #64ffda;
        }
        
        .signup-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .email-hint {
            color: #8892b0;
            font-size: 0.8rem;
            margin-top: 0.2rem;
            margin-bottom: 0.5rem;
        }
        
        .email-hint span {
            color: #64ffda;
        }
        
        /* LOGIN PAGE */
        #loginPage {
            width: 100%;
            min-height: 100vh;
            background: #0a192f;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        .login-container {
            width: 100%;
            max-width: 400px;
            background: #172a45;
            padding: 2rem 1.5rem;
            border-radius: 20px;
            border: 2px solid #64ffda;
        }
        
        .login-container h1 {
            color: #64ffda;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 1.8rem;
        }
        
        .login-container input {
            width: 100%;
            padding: 0.9rem 1rem;
            margin: 0.5rem 0;
            background: #0a192f;
            border: 2px solid #64ffda;
            border-radius: 8px;
            color: white;
        }
        
        .login-container button {
            width: 100%;
            padding: 1rem;
            margin: 1.5rem 0 1rem;
            background: linear-gradient(135deg, #64ffda, #00b4d8);
            color: #0a192f;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
        }
        
        /* MAIN APP */
        #mainApp {
            display: none;
        }
        
        .everest-header {
            height: 30vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to top, #7fc1ff, white);
            padding: 10px;
        }
        
        .everest-text h1 {
            font-size: 3.5rem;
            font-weight: 900;
            text-transform: uppercase;
            background-image: url('mount.jpg');
            background-size: cover;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: georgia;
            text-align: center;
            line-height: 1.1;
        }
        
        .everest-text .tagline {
            font-size: 1rem;
            color: cyan;
            text-align: center;
        }
        
        .main-nav {
            background: rgba(23, 42, 69, 0.95);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            flex: 1 1 auto;
            padding: 0.8rem 0.3rem;
            background: none;
            border: none;
            color: #aae1ff;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            color: #64ffda;
            border-bottom: 2px solid #64ffda;
        }
        
        .content-section {
            display: none;
            padding: 1.2rem;
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #ccd6f6;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #64ffda;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.4rem;
            color: #64ffda;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(23, 42, 69, 0.7);
            border: 2px solid rgba(100, 255, 218, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
        }
        
        .category-grid, .regions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .category-btn, .region-btn {
            padding: 8px 5px;
            border: 2px solid rgba(100, 255, 218, 0.2);
            border-radius: 8px;
            background: rgba(23, 42, 69, 0.5);
            color: #8892b0;
            cursor: pointer;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .category-btn.selected, .region-btn.selected {
            border-color: #64ffda;
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #64ffda, #00b4d8);
            color: #0a192f;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px #64ffda;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 600px) {
            .items-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .item-card {
            background: rgba(23, 42, 69, 0.7);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(100, 255, 218, 0.1);
        }
        
        .item-image {
            height: 160px;
            overflow: hidden;
            position: relative;
        }
        
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .item-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(10, 25, 47, 0.9);
            color: #64ffda;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
        }
        
        .item-content {
            padding: 1rem;
        }
        
        .item-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: #64ffda;
            margin-bottom: 0.3rem;
        }
        
        .item-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ccd6f6;
            margin-bottom: 0.3rem;
        }
        
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding: 5px 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 2px solid rgba(100, 255, 218, 0.2);
            border-radius: 20px;
            background: rgba(23, 42, 69, 0.5);
            cursor: pointer;
            color: #8892b0;
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        
        .filter-btn.active {
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            border-color: #64ffda;
        }
        
        .whatsapp-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 0.6rem;
            border-radius: 6px;
            width: 100%;
            margin: 0.3rem 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        #userMenuBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #64ffda;
            color: #0a192f;
            border: none;
            padding: 6px 14px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 1000;
        }
        
        .app-footer {
            text-align: center;
            padding: 1rem;
            color: #8892b0;
            font-size: 0.75rem;
        }
        
        #by {
            color: #64ffda;
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
        }
        
        #regionsList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .region-item {
            background: rgba(23, 42, 69, 0.7);
            padding: 0.6rem;
            border-radius: 6px;
            border: 1px solid #64ffda;
            color: #ccd6f6;
            font-size: 0.8rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- CUSTOM ALERT -->
    <div id="customAlert">
        <div class="alert-content" id="alertContent">
            <div class="alert-icon" id="alertIcon">‚úì</div>
            <div class="alert-message" id="alertMessage"></div>
            <button class="alert-close" onclick="hideAlert()">‚úï</button>
        </div>
    </div>

    <!-- SIGN UP PAGE -->
    <div id="signupPage">
        <div class="signup-container">
            <h1>EVEREST</h1>
            <div class="subtitle">Eswatini Marketplace</div>
            
            <input type="text" id="signupUsername" placeholder="Username" oninput="validateAll()">
            <input type="email" id="signupEmail" placeholder="Email (must have @ and .com/.co.za/etc)" oninput="validateAll()">
            <div class="email-hint">Examples: <span>name@gmail.com</span> ‚Ä¢ <span>name@yahoo.com</span> ‚Ä¢ <span>name@icloud.com</span></div>
            <input type="password" id="signupPassword" placeholder="Password (min 6)" oninput="validateAll()">
            <input type="password" id="signupConfirm" placeholder="Confirm Password" oninput="validateAll()">
            
            <button id="signupBtn" onclick="signup()" disabled>CREATE ACCOUNT</button>
            
            <div style="text-align:center; color:#8892b0; margin-top:1rem;">
                Already have an account? <a onclick="showLogin()" style="color:#64ffda; cursor:pointer;">Sign In</a>
            </div>
        </div>
    </div>
    
    <!-- LOGIN PAGE -->
    <div id="loginPage">
        <div class="login-container">
            <h1>WELCOME BACK</h1>
            
            <input type="text" id="loginUsername" placeholder="Username or Email">
            <input type="password" id="loginPassword" placeholder="Password">
            
            <button onclick="login()">SIGN IN</button>
            
            <div style="text-align:center; color:#8892b0; margin-top:1rem;">
                Don't have an account? <a onclick="showSignup()" style="color:#64ffda; cursor:pointer;">Sign Up</a>
            </div>
        </div>
    </div>
    
    <!-- MAIN APP -->
    <div id="mainApp">
        <button id="userMenuBtn" onclick="logout()">üë§ Loading...</button>
        
        <header class="everest-header">
            <div class="everest-text">
                <h1>EVEREST</h1>
                <div class="tagline">Connecting Eswatini</div>
            </div>
        </header>
        
        <nav class="main-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('create')">‚ûï Create</button>
                <button class="nav-tab" onclick="showTab('discover')">üîç Browse</button>
                <button class="nav-tab" onclick="showTab('mylistings')">üìã My Items</button>
                <button class="nav-tab" onclick="showTab('regions')">üó∫Ô∏è Regions</button>
            </div>
        </nav>
        
        <!-- CREATE SECTION -->
        <section id="createSection" class="content-section active">
            <div id="by">by Lihle Simon Mthembu</div>
            <h2 class="section-title">Create Listing</h2>
            
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" id="itemTitle" class="form-input" placeholder="What are you selling?">
            </div>
            
            <div class="form-group">
                <label class="form-label">Price (SZL)</label>
                <input type="number" id="itemPrice" class="form-input" placeholder="Enter price">
            </div>
            
            <div class="form-group">
                <label class="form-label">Category</label>
                <div class="category-grid" id="categoryGrid"></div>
                <input type="hidden" id="itemCategory">
            </div>
            
            <div class="form-group">
                <label class="form-label">Location</label>
                <div class="regions-grid" id="regionsGrid"></div>
                <input type="hidden" id="itemLocation">
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="itemDescription" class="form-input" rows="3" placeholder="Describe your item..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">WhatsApp</label>
                <input type="text" id="itemWhatsapp" class="form-input" placeholder="+268...">
            </div>
            
            <button class="submit-btn" onclick="createListing()">PUBLISH LISTING</button>
        </section>
        
        <!-- DISCOVER SECTION -->
        <section id="discoverSection" class="content-section">
            <h2 class="section-title">Marketplace</h2>
            
            <input type="text" id="searchInput" class="form-input" placeholder="Search..." onkeyup="renderDiscover()">
            
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterListings('all')">All</button>
                <button class="filter-btn" onclick="filterListings('vehicles')">Vehicles</button>
                <button class="filter-btn" onclick="filterListings('electronics')">Electronics</button>
                <button class="filter-btn" onclick="filterListings('property')">Property</button>
                <button class="filter-btn" onclick="filterListings('other')">Other</button>
            </div>
            
            <div id="discoverGrid" class="items-grid"></div>
        </section>
        
        <!-- MY LISTINGS SECTION -->
        <section id="mylistingsSection" class="content-section">
            <h2 class="section-title">My Listings</h2>
            <div id="myListingsGrid" class="items-grid"></div>
        </section>
        
        <!-- REGIONS SECTION -->
        <section id="regionsSection" class="content-section">
            <h2 class="section-title">Eswatini Regions</h2>
            <div id="regionsList"></div>
        </section>
    </div>

    <script>
        // ==================== CONFIG ====================
        const COLLECTION_ID = '6998950043b1c97be98edc23';
        const API_URL = `https://json.io/api/collections/${COLLECTION_ID}`;
        
        // ==================== GLOBAL DATA ====================
        let currentUser = null;
        let listings = [];
        let users = [];
        let currentFilter = 'all';
        
        // ==================== ESWATINI REGIONS ====================
        const ESWATINI_REGIONS = [
            'Mbabane', 'Manzini', 'Piggs Peak', 'Lobamba', 'Siteki',
            'Nhlangano', 'Hlatikulu', 'Big Bend', 'Matsapha', 'Malkerns'
        ];

        // ==================== CATEGORIES ====================
        const CATEGORIES = [
            { id: 'vehicles', name: 'Vehicles' },
            { id: 'electronics', name: 'Electronics' },
            { id: 'property', name: 'Property' },
            { id: 'other', name: 'Other' }
        ];
        
        // ==================== CUSTOM ALERT ====================
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('customAlert');
            const content = document.getElementById('alertContent');
            const icon = document.getElementById('alertIcon');
            const msg = document.getElementById('alertMessage');
            
            if (type === 'success') {
                content.className = 'alert-content alert-success';
                icon.innerHTML = '‚úì';
            } else if (type === 'error') {
                content.className = 'alert-content alert-error';
                icon.innerHTML = '‚úï';
            } else if (type === 'warning') {
                content.className = 'alert-content alert-warning';
                icon.innerHTML = '‚ö†';
            }
            
            msg.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(hideAlert, 3000);
        }
        
        function hideAlert() {
            document.getElementById('customAlert').style.display = 'none';
        }
        
        // ==================== STRICT EMAIL VALIDATION ====================
        function isValidEmail(email) {
            if (!email.includes('@')) return false;
            
            const localPart = email.split('@')[0];
            if (localPart.length < 1) return false;
            
            const domain = email.split('@')[1];
            if (!domain || !domain.includes('.')) return false;
            
            const validDomains = [
                'gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com',
                'icloud.com', 'aol.com', 'mail.com', 'protonmail.com',
                'co.za', 'org', 'net', 'edu', 'gov'
            ];
            
            const domainLower = domain.toLowerCase();
            for (let validDomain of validDomains) {
                if (domainLower.endsWith(validDomain)) {
                    return true;
                }
            }
            
            const domainParts = domain.split('.');
            if (domainParts.length < 2) return false;
            
            const tld = domainParts[domainParts.length - 1];
            if (tld.length < 2) return false;
            
            return true;
        }
        
        // ==================== VALIDATION FUNCTIONS ====================
        function validateAll() {
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            const signupBtn = document.getElementById('signupBtn');
            
            let isValid = true;
            
            const usernameInput = document.getElementById('signupUsername');
            if (username && username.length < 3) {
                usernameInput.classList.add('invalid');
                usernameInput.classList.remove('valid');
                isValid = false;
            } else if (username) {
                usernameInput.classList.remove('invalid');
                usernameInput.classList.add('valid');
            }
            
            const emailInput = document.getElementById('signupEmail');
            if (email && !isValidEmail(email)) {
                emailInput.classList.add('invalid');
                emailInput.classList.remove('valid');
                isValid = false;
            } else if (email) {
                emailInput.classList.remove('invalid');
                emailInput.classList.add('valid');
            }
            
            const passInput = document.getElementById('signupPassword');
            if (password && password.length < 6) {
                passInput.classList.add('invalid');
                passInput.classList.remove('valid');
                isValid = false;
            } else if (password) {
                passInput.classList.remove('invalid');
                passInput.classList.add('valid');
            }
            
            const confirmInput = document.getElementById('signupConfirm');
            if (confirm && confirm !== password) {
                confirmInput.classList.add('invalid');
                confirmInput.classList.remove('valid');
                isValid = false;
            } else if (confirm) {
                confirmInput.classList.remove('invalid');
                confirmInput.classList.add('valid');
            }
            
            signupBtn.disabled = !isValid || !username || !email || !password || !confirm;
        }
        
        // ==================== PAGE FUNCTIONS ====================
        function showSignup() {
            document.getElementById('signupPage').style.display = 'flex';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
        }
        
        function showLogin() {
            document.getElementById('signupPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }
        
        function showMainApp() {
            document.getElementById('signupPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }
        
        // ==================== DATABASE ====================
        async function loadData() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                if (Array.isArray(data)) {
                    listings = data.filter(item => item.type === 'listing') || [];
                    users = data.filter(item => item.type === 'user') || [];
                }
            } catch (e) {
                listings = [];
                users = [];
            }
        }
        
        async function saveData() {
            try {
                const allData = [
                    ...listings.map(l => ({ ...l, type: 'listing' })),
                    ...users.map(u => ({ ...u, type: 'user' }))
                ];
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allData)
                });
            } catch (e) {}
        }
        
        // ==================== SIGNUP ====================
        async function signup() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            
            if (!username || !email || !password || !confirm) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            if (username.length < 3) {
                showAlert('Username must be at least 3 characters', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showAlert('Please enter a valid email address (e.g., name@gmail.com)', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (password !== confirm) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            await loadData();
            
            if (users.find(u => u.username === username)) {
                showAlert('Username already taken', 'error');
                return;
            }
            
            if (users.find(u => u.email === email)) {
                showAlert('Email already registered', 'error');
                return;
            }
            
            const newUser = {
                id: 'user_' + Date.now(),
                username: username,
                email: email,
                password: btoa(password),
                joined: new Date().toISOString()
            };
            
            users.push(newUser);
            await saveData();
            
            currentUser = newUser;
            document.getElementById('userMenuBtn').innerHTML = `üë§ ${username}`;
            
            setupCategories();
            setupRegions();
            showMainApp();
            renderDiscover();
            renderRegions();
            
            showAlert('Account created successfully! Welcome to EVEREST! üéâ', 'success');
        }
        
        // ==================== LOGIN ====================
        async function login() {
            const loginInput = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!loginInput || !password) {
                showAlert('Please enter username/email and password', 'error');
                return;
            }
            
            await loadData();
            
            const user = users.find(u => 
                (u.username === loginInput || u.email === loginInput) && 
                u.password === btoa(password)
            );
            
            if (user) {
                currentUser = user;
                document.getElementById('userMenuBtn').innerHTML = `üë§ ${user.username}`;
                
                setupCategories();
                setupRegions();
                showMainApp();
                renderDiscover();
                renderRegions();
                
                showAlert(`Welcome back, ${user.username}! üëã`, 'success');
            } else {
                showAlert('Invalid username/email or password', 'error');
            }
        }
        
        // ==================== LOGOUT ====================
        function logout() {
            currentUser = null;
            showSignup();
            showAlert('Logged out successfully', 'success');
        }
        
        // ==================== SETUP CATEGORIES ====================
        function setupCategories() {
            const grid = document.getElementById('categoryGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            CATEGORIES.forEach(category => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'category-btn';
                btn.textContent = category.name;
                
                btn.onclick = function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('itemCategory').value = category.id;
                };
                
                grid.appendChild(btn);
            });
        }
        
        // ==================== SETUP REGIONS ====================
        function setupRegions() {
            const grid = document.getElementById('regionsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            ESWATINI_REGIONS.forEach(region => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'region-btn';
                btn.textContent = region;
                
                btn.onclick = function() {
                    document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('itemLocation').value = region;
                };
                
                grid.appendChild(btn);
            });
        }
        
        // ==================== CREATE LISTING ====================
        async function createListing() {
            if (!currentUser) {
                showSignup();
                return;
            }
            
            const title = document.getElementById('itemTitle').value.trim();
            const price = document.getElementById('itemPrice').value.trim();
            const category = document.getElementById('itemCategory').value;
            const location = document.getElementById('itemLocation').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const whatsapp = document.getElementById('itemWhatsapp').value.trim();
            
            if (!title || !price || !category || !location || !description || !whatsapp) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            const newListing = {
                id: 'listing_' + Date.now(),
                userId: currentUser.id,
                username: currentUser.username,
                title: title,
                price: parseFloat(price),
                category: category,
                location: location,
                description: description,
                whatsapp: whatsapp,
                date: new Date().toISOString()
            };
            
            listings.unshift(newListing);
            await saveData();
            
            document.getElementById('itemTitle').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemLocation').value = '';
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemWhatsapp').value = '';
            
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('selected'));
            
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab')[1].classList.add('active');
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('discoverSection').classList.add('active');
            
            renderDiscover();
            
            showAlert('Listing published successfully! üéâ', 'success');
        }
        
        // ==================== DELETE LISTING ====================
        async function deleteListing(id) {
            if (!currentUser) return;
            
            const listing = listings.find(l => l.id === id);
            if (!listing || listing.userId !== currentUser.id) {
                showAlert('You can only delete your own listings', 'error');
                return;
            }
            
            if (confirm('Delete this listing?')) {
                listings = listings.filter(l => l.id !== id);
                await saveData();
                renderDiscover();
                renderMyListings();
                showAlert('Listing deleted', 'success');
            }
        }
        
        // ==================== RENDER DISCOVER ====================
        function renderDiscover() {
            const grid = document.getElementById('discoverGrid');
            const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
            
            let items = listings.filter(l => currentFilter === 'all' || l.category === currentFilter)
                                .filter(l => !search || l.title.toLowerCase().includes(search));
            
            if (items.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color:#8892b0; padding:2rem;">No listings found</p>';
                return;
            }
            
            let html = '';
            items.forEach(item => {
                const isOwner = currentUser && currentUser.id === item.userId;
                html += `
                    <div class="item-card">
                        <div class="item-image">
                            <img src="https://images.unsplash.com/photo-1586769852044-692eb51d3d6e?w=400" alt="Item">
                            <div class="item-badge">${item.location}</div>
                        </div>
                        <div class="item-content">
                            <div class="item-price">E${item.price}</div>
                            <div class="item-title">${item.title}</div>
                            <button class="whatsapp-btn" onclick="window.open('https://wa.me/${item.whatsapp}')">üí¨ WhatsApp</button>
                            ${isOwner ? `<button class="delete-btn" onclick="deleteListing('${item.id}')">üóëÔ∏è Delete</button>` : ''}
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }
        
        // ==================== RENDER MY LISTINGS ====================
        function renderMyListings() {
            if (!currentUser) return;
            
            const grid = document.getElementById('myListingsGrid');
            const myItems = listings.filter(l => l.userId === currentUser.id);
            
            if (myItems.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color:#8892b0; padding:2rem;">You have no listings</p>';
                return;
            }
            
            let html = '';
            myItems.forEach(item => {
                html += `
                    <div class="item-card">
                        <div class="item-content">
                            <div class="item-price">E${item.price}</div>
                            <div class="item-title">${item.title}</div>
                            <div style="color:#8892b0; margin:0.5rem 0;">üìç ${item.location}</div>
                            <button class="delete-btn" onclick="deleteListing('${item.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }
        
        // ==================== RENDER REGIONS ====================
        function renderRegions() {
            const container = document.getElementById('regionsList');
            if (!container) return;
            
            let html = '';
            ESWATINI_REGIONS.forEach(region => {
                html += `<div class="region-item">üìç ${region}</div>`;
            });
            container.innerHTML = html;
        }
        
        // ==================== FILTER ====================
        function filterListings(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderDiscover();
        }
        
        // ==================== TAB ====================
        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(tab + 'Section').classList.add('active');
            
            if (tab === 'discover') renderDiscover();
            if (tab === 'mylistings') renderMyListings();
            if (tab === 'regions') renderRegions();
        }
        
        // ==================== START ====================
        window.onload = function() {
            showSignup();
            loadData();
            document.getElementById('signupBtn').disabled = true;
        };
    </script>
</body>
</html>